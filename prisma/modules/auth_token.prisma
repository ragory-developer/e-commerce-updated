// ─── Auth Token (shared between Admin & Customer) ────────────
// Replaces the old Session model. Supports both user types.

model AuthToken {
  id String @id @default(cuid())

  userType AuthUserType

  // Only ONE of these will be set
  adminId String? @map("admin_id")
  admin   Admin?  @relation(fields: [adminId], references: [id], onDelete: Cascade)

  customerId String?   @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")

  revoked       Boolean   @default(false)
  revokedAt     DateTime? @map("revoked_at")
  revokedReason String?   @map("revoked_reason") @db.VarChar(100)

  deviceInfo String? @map("device_info") @db.VarChar(255)
  ipAddress  String? @map("ip_address") @db.VarChar(45)
  userAgent  String? @map("user_agent") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([tokenHash])
  @@index([userType])
  @@index([adminId])
  @@index([customerId])
  @@index([expiresAt])
  @@index([revoked])
  @@map("auth_tokens")
}

// ─── OTP Verification ────────────────────────────────────────
model VerificationOtp {
  id String @id @default(cuid())

  channel OtpChannel
  purpose OtpPurpose

  target String @db.VarChar(255) // phone number or email

  codeHash  String   @map("code_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")

  attempts    Int @default(0)
  maxAttempts Int @default(5) @map("max_attempts")

  verified   Boolean   @default(false)
  verifiedAt DateTime? @map("verified_at")

  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([target])
  @@index([channel, purpose])
  @@index([expiresAt])
  @@map("verification_otps")
}
